义工时数管理系统 JavaScript 文件说明文档

1. src/app.js
功能：应用程序的主入口文件
作用：
- 初始化 Express 应用
- 配置中间件
- 设置路由
- 建立数据库连接
- 启动服务器
实现细节：
- 使用 express() 创建应用实例
- 配置安全相关中间件（helmet）用于增强 HTTP 头部安全性
- 设置速率限制防止 DOS 攻击
- 配置 CORS 允许跨域请求
- 解析 JSON 和 URL 编码的请求体
- 提供静态文件服务
- 连接 MongoDB 数据库
- 注册认证和记录相关路由
- 添加错误处理中间件
- 实现优雅关闭机制

2. src/config/config.js
功能：集中管理应用配置
作用：
- 管理环境变量
- 提供配置对象
实现细节：
- 使用 dotenv 加载环境变量
- 导出服务器配置（端口、环境等）
- 导出数据库配置（连接 URI、选项等）
- 导出 JWT 配置（密钥、过期时间等）
- 导出 CORS 配置

3. src/models/user.js
功能：用户数据模型定义
作用：
- 定义用户文档结构
- 处理密码加密
- 提供用户相关方法
实现细节：
- 使用 mongoose.Schema 定义用户模式
- 包含字段：用户名、密码（加密）、姓名、角色等
- 使用 bcrypt 在保存前自动加密密码
- 提供密码验证方法
- 定义索引和验证规则

4. src/routes/auth.js
功能：处理认证相关路由
作用：
- 处理用户注册
- 处理用户登录
- 获取用户信息
实现细节：
- 使用 express.Router() 创建路由器
- 实现注册逻辑：验证输入、检查用户存在、创建用户、生成 token
- 实现登录逻辑：验证凭据、生成 token
- 实现获取用户信息的路由
- 使用 JWT 进行身份验证

5. src/routes/records.js
功能：处理义工记录相关路由
作用：
- 创建义工记录
- 查询义工记录
- 更新和删除记录
实现细节：
- 定义记录的 CRUD 操作路由
- 实现记录验证和权限检查
- 提供记录查询和统计功能
- 使用认证中间件保护路由

6. src/middleware/auth.js
功能：认证中间件
作用：
- 验证请求中的 JWT token
- 提取用户信息
实现细节：
- 从请求头部获取 token
- 验证 token 的有效性
- 解码 token 获取用户 ID
- 将用户信息添加到请求对象

7. public/login_test.html
功能：前端测试页面
作用：
- 提供用户界面
- 测试 API 功能
实现细节：
- 实现注册表单和处理
- 实现登录表单和处理
- 展示用户信息
- 使用 fetch API 调用后端接口
- 处理响应和错误
- 管理本地 token 存储

8. src/tests/api_test.js
功能：API 测试脚本
作用：
- 测试 API 端点
- 验证功能正确性
实现细节：
- 使用 node-fetch 发送 HTTP 请求
- 测试注册功能
- 测试登录功能
- 验证响应格式和内容
- 输出测试结果

文件关系说明：
1. app.js 作为主入口，整合了其他所有组件
2. config.js 为其他文件提供配置信息
3. models 定义数据结构，被路由处理器使用
4. routes 处理具体的 API 请求，使用模型和中间件
5. middleware 为路由提供通用功能
6. 前端文件通过 API 与后端交互
7. 测试文件独立验证功能

部署相关文件：

1. Dockerfile
功能：定义容器构建过程
作用：
- 创建应用容器
- 设置运行环境
实现细节：
- 使用 Node.js 基础镜像
- 复制应用文件
- 安装依赖
- 配置健康检查
- 设置启动命令

2. .env
功能：环境变量配置
作用：
- 存储敏感配置
- 环境特定设置
实现细节：
- 定义数据库连接字符串
- 设置 JWT 密钥
- 配置服务器端口
- 设置环境标识

工具脚本说明：

9. src/utils/backup.js
功能：数据库备份工具
作用：
- 定期备份 MongoDB 数据
- 管理备份文件
- 提供数据恢复功能
实现细节：
- 使用 MongoDB 原生备份工具 mongodump
- 创建带时间戳的备份文件
- 压缩备份文件以节省空间
- 保留指定数量的最新备份
- 提供命令行接口进行手动备份
- 支持自动定时备份

10. src/utils/export.js
功能：数据导出工具
作用：
- 导出义工时数记录
- 生成报表文件
- 支持多种导出格式
实现细节：
- 支持导出为 CSV 和 Excel 格式
- 按时间范围筛选数据
- 按用户或活动类型分组
- 计算统计数据（总时数、平均时数等）
- 自定义导出字段选择
- 文件命名包含导出时间和筛选条件

11. src/utils/statistics.js
功能：数据统计分析工具
作用：
- 计算义工时数统计信息
- 生成统计报告
- 提供数据分析功能
实现细节：
- 计算个人和团体总时数
- 按月份/季度/年度统计时数
- 生成活动参与率分析
- 计算时数增长趋势
- 识别活跃义工
- 生成统计图表数据

注意：这些工具脚本目前尚未实现，是系统后续开发的重要组成部分。建议按以下优先级实现：

1. backup.js - 数据安全最重要
2. export.js - 满足基本报表需求
3. statistics.js - 提供深入分析

实现建议：
- backup.js 应考虑使用 node-cron 实现定时任务
- export.js 可使用 excel4node 或 json2csv 处理文件导出
- statistics.js 可使用 mongoose 聚合管道实现复杂统计
